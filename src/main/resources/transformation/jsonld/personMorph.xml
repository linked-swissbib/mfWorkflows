<?xml version="1.0" encoding="UTF-8"?>

<metamorph xmlns="http://www.culturegraph.org/metamorph" version="1">

	<vars>
		<var name="swissbib_domain" value="http://data.swissbib.ch/resource/"/>
	</vars>


	<macros>
		<macro name="bulk-header">
			<!-- Writes header line as required by the Elasticsearch Bulk API -->
			<entity name="index" flushWith="$[fw]">

				<data name="_type" source="$[id]">
					<constant value="person"/>
				</data>

				<data name="_id" source="$[id]" />

				<data name="_index" source="$[id]">
					<constant value="testsb" />
				</data>

			</entity>
		</macro>
	</macros>


	<rules>

		<combine name="@key1000" value="${name}##${number}##${title}##${lifedata}##${fullname}" flushWith="1000 ">
			<data source="1000 .a" name="name" />
			<data source="1000 .b" name="number" />
			<data source="1000 .c" name="title" />
			<data source="1000 .d" name="lifedata" />
			<data source="1000 .q" name="fullname" />
			<postprocess>
				<java class="org.swissbib.linked.mf.morph.functions.AuthorHash"/>
			</postprocess>
		</combine>
		<combine name="@key1001" value="${lastname}##${firstname}##${number}##${title}##${lifedata}##${fullname}" flushWith="1001 ">
			<data source="1001 .a" name="lastname" />
			<data source="1001 .D" name="firstname" />
			<data source="1001 .b" name="number" />
			<data source="1001 .c" name="title" />
			<data source="1001 .d" name="lifedata" />
			<data source="1001 .q" name="fullname" />
			<postprocess>
				<java class="org.swissbib.linked.mf.morph.functions.AuthorHash"/>
			</postprocess>
		</combine>
		<combine name="@key7000" value="${name}##${number}##${title}##${lifedata}##${fullname}" flushWith="7000 ">
			<data source="7000 .a" name="name" />
			<data source="7000 .b" name="number" />
			<data source="7000 .c" name="title" />
			<data source="7000 .d" name="lifedata" />
			<data source="7000 .q" name="fullname" />
			<postprocess>
				<java class="org.swissbib.linked.mf.morph.functions.AuthorHash"/>
			</postprocess>
		</combine>
		<combine name="@key7001" value="${lastname}##${firstname}##${number}##${title}##${lifedata}##${fullname}" flushWith="7001 ">
			<data source="7001 .a" name="lastname" />
			<data source="7001 .D" name="firstname" />
			<data source="7001 .b" name="number" />
			<data source="7001 .c" name="title" />
			<data source="7001 .d" name="lifedata" />
			<data source="7001 .q" name="fullname" />
			<postprocess>
				<java class="org.swissbib.linked.mf.morph.functions.AuthorHash"/>
			</postprocess>
		</combine>

		<!--BUILD THE BASIS RECORD -->

		<call-macro name="bulk-header" fw="1000 " id="@key1000" />
		<!--100 first indicator 0-->
		<entity name="--" flushWith="1000 " >
			<data name="@id" source="@key1000" >
				<compose prefix="http://data.swissbib.ch/person/" />
			</data>
			<combine name="rdfs:label" value="${name}${number}${developed}${dates}${note}" flushWith="1000 " sameEntity="true" >
				<data source="1000 .a" name="name" />
				<data source="1000 .b" name="number" >
					<compose prefix=" " />
				</data>
				<data source="1000 .q" name="developed" >
					<compose prefix=" (" postfix=")" />
				</data>
				<data source="1000 .d" name="dates" >
					<compose prefix=", " />
				</data>
				<data source="1000 .c" name="note" >
					<compose prefix=", " />
				</data>
			</combine>
			<data source="1000 .d" name="dbp:birthYear" >
				<regexp match="(\d\d\d\d).?[-]" format="${1}" />
			</data>
			<data source="1000 .d" name="dbp:deathYear" >
				<regexp match="(\d\d\d\d)$" format="${1}" />
			</data>
			<data source="1000 .a" name="foaf:name" />
			<data source="1000 .c" name="skos:note" />
		</entity>

		<call-macro name="bulk-header" fw="1001 " id="@key1001" />
		<!--100 first indicator 1-->
		<entity name="--" flushWith="1001 " >
			<data name="@id" source="@key1001" >
				<compose prefix="http://data.swissbib.ch/person/" />
			</data>
			<combine name="rdfs:label" value="${lastname}${firstname}${number}${developed}${dates}${note}" flushWith="1001 " sameEntity="true" >
				<data source="1001 .a" name="lastname" />
				<data source="1001 .D" name="firstname" >
					<compose prefix=", " />
				</data>
				<data source="1001 .b" name="number" >
					<compose prefix=" " />
				</data>
				<data source="1001 .q" name="developed" >
					<compose prefix=" (" postfix=")" />
				</data>
				<data source="1001 .d" name="dates" >
					<compose prefix=", " />
				</data>
				<data source="1001 .c" name="note" >
					<compose prefix=", " />
				</data>
			</combine>
			<data source="1001 .d" name="dbp:birthYear" >
				<regexp match="(\d\d\d\d).?[-]" format="${1}" />
			</data>
			<data source="1001 .d" name="dbp:deathYear" >
				<regexp match="(\d\d\d\d)$" format="${1}" />
			</data>
			<data source="1001 .a" name="foaf:lastName" />
			<data source="1001 .D" name="foaf:firstName" />
			<data source="1001 .c" name="skos:note" />
		</entity>

		<call-macro name="bulk-header" fw="7000 " id="@key7000" />
		<!--700 first indicator 0-->
		<entity name="--" flushWith="7000 " >
			<data name="@id" source="@key7000" >
				<compose prefix="http://data.swissbib.ch/person/" />
			</data>
			<combine name="rdfs:label" value="${name}${number}${developed}${dates}${note}" flushWith="7000 " sameEntity="true" >
				<data source="7000 .a" name="name" />
				<data source="7000 .b" name="number" >
					<compose prefix=" " />
				</data>
				<data source="7000 .q" name="developed" >
					<compose prefix=" (" postfix=")" />
				</data>
				<data source="7000 .d" name="dates" >
					<compose prefix=", " />
				</data>
				<data source="7000 .c" name="note" >
					<compose prefix=", " />
				</data>
			</combine>
			<data source="7000 .d" name="dbp:birthYear" >
				<regexp match="(\d\d\d\d).?[-]" format="${1}" />
			</data>
			<data source="7000 .d" name="dbp:deathYear" >
				<regexp match="(\d\d\d\d)$" format="${1}" />
			</data>
			<data source="7000 .a" name="foaf:name" />
			<data source="7000 .c" name="skos:note" />
		</entity>

		<call-macro name="bulk-header" fw="7001 " id="@key7001" />
		<!--700 first indicator 1-->
		<entity name="--" flushWith="7001 " >
			<data name="@id" source="@key7001" >
				<compose prefix="http://data.swissbib.ch/person/" />
			</data>
			<combine name="rdfs:label" value="${lastname}${firstname}${number}${developed}${dates}${note}" flushWith="7001 " sameEntity="true" >
				<data source="7001 .a" name="lastname" />
				<data source="7001 .D" name="firstname" >
					<compose prefix=", " />
				</data>
				<data source="7001 .b" name="number" >
					<compose prefix=" " />
				</data>
				<data source="7001 .q" name="developed" >
					<compose prefix=" (" postfix=")" />
				</data>
				<data source="7001 .d" name="dates" >
					<compose prefix=", " />
				</data>
				<data source="7001 .c" name="note" >
					<compose prefix=", " />
				</data>
			</combine>
			<data source="7001 .d" name="dbp:birthYear" >
				<regexp match="(\d\d\d\d).?[-]" format="${1}" />
			</data>
			<data source="7001 .d" name="dbp:deathYear" >
				<regexp match="(\d\d\d\d)$" format="${1}" />
			</data>
			<data source="7001 .a" name="foaf:lastName" />
			<data source="7001 .D" name="foaf:firstName" />
			<data source="7001 .c" name="skos:note" />
		</entity>		

	</rules>

</metamorph>
