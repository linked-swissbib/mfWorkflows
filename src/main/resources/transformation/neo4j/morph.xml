<?xml version="1.0" encoding="UTF-8"?>

<metamorph xmlns="http://www.culturegraph.org/metamorph" version="1">

    <rules>

        <!-- Definitions for recursions to be used later in substructures (must be set here!) -->

        <combine name="@key1000" value="${name}##${number}##${title}##${lifedata}##${fullname}" flushWith="1000 ">
            <data source="1000 .a" name="name"/>
            <data source="1000 .b" name="number"/>
            <data source="1000 .c" name="title"/>
            <data source="1000 .d" name="lifedata"/>
            <data source="1000 .q" name="fullname"/>
            <postprocess>
                <java class="org.swissbib.linked.mf.morph.functions.AuthorHash"/>
            </postprocess>
        </combine>
        <combine name="@key1001" value="${lastname}##${firstname}##${number}##${title}##${lifedata}##${fullname}"
                 flushWith="1001 ">
            <data source="1001 .a" name="lastname"/>
            <data source="1001 .D" name="firstname"/>
            <data source="1001 .b" name="number"/>
            <data source="1001 .c" name="title"/>
            <data source="1001 .d" name="lifedata"/>
            <data source="1001 .q" name="fullname"/>
            <postprocess>
                <java class="org.swissbib.linked.mf.morph.functions.AuthorHash"/>
            </postprocess>
        </combine>
        <combine name="@key7000" value="${name}##${number}##${title}##${lifedata}##${fullname}" flushWith="7000 ">
            <data source="7000 .a" name="name"/>
            <data source="7000 .b" name="number"/>
            <data source="7000 .c" name="title"/>
            <data source="7000 .d" name="lifedata"/>
            <data source="7000 .q" name="fullname"/>
            <postprocess>
                <java class="org.swissbib.linked.mf.morph.functions.AuthorHash"/>
            </postprocess>
        </combine>
        <combine name="@key7001" value="${lastname}##${firstname}##${number}##${title}##${lifedata}##${fullname}"
                 flushWith="7001 ">
            <data source="7001 .a" name="lastname"/>
            <data source="7001 .D" name="firstname"/>
            <data source="7001 .b" name="number"/>
            <data source="7001 .c" name="title"/>
            <data source="7001 .d" name="lifedata"/>
            <data source="7001 .q" name="fullname"/>
            <postprocess>
                <java class="org.swissbib.linked.mf.morph.functions.AuthorHash"/>
            </postprocess>
        </combine>
        <combine name="@key710" value="${name}##${subunit}##${number}##${date}##${location}" flushWith="710??">
            <data source="710??.a" name="name"/>
            <data source="710??.b" name="subunit"/>
            <data source="710??.n" name="number"/>
            <data source="710??.d" name="date"/>
            <data source="710??.c" name="location"/>
            <postprocess>
                <java class="org.swissbib.linked.mf.morph.functions.AuthorHash"/>
            </postprocess>
        </combine>
        <combine name="@key711" value="${name}##${subunit}##${number}##${date}##${location}" flushWith="711??">
            <data source="710??.a" name="name"/>
            <data source="710??.e" name="subunit"/>
            <data source="710??.n" name="number"/>
            <data source="710??.d" name="date"/>
            <data source="710??.c" name="location"/>
            <postprocess>
                <java class="org.swissbib.linked.mf.morph.functions.AuthorHash"/>
            </postprocess>
        </combine>

        <combine name="@key_item"
                 value="${id_record}##${system_number}##${id_network}##${shelfmark1}##${shelfmark2}##${sublocation}##${description}##${barcode}##${posNumber}"
                 flushWith="949??">
            <data source="001" name="id_record"/>
            <data source="949??.E" name="system_number"/>
            <data source="949??.B" name="id_network"/>
            <data source="949??.j" name="shelfmark1"/>
            <data source="949??.s" name="shelfmark2"/>
            <data source="949??.b" name="sublocation"/>
            <data source="949??.z" name="description"/>
            <data source="949??.p" name="barcode"/>
            <data source="949??.B" name="posNumber">
                <count/>
            </data>
            <postprocess>
                <java class="org.swissbib.linked.mf.morph.functions.AuthorHash"/>
            </postprocess>
            <!--The elements composing the IRI of the item are:
                - record id (001)
                - system number of the item (949$E)
                - library network (949$B)
                - shelfmark 1+2 (949$j + 949$s)
                - sublocation (949$b)
                - description (949$z)
                - barcode (949$p)
                - position of the field 949$B in the MARC record
            -->
        </combine>

        <!-- Set id -->
        <data source="001" name="_id"/>

        <!--when first indicator is 0-->
        <data name="dct:contributor" source="@key1000">
            <compose prefix="http://data.swissbib.ch/person/"/>
        </data>
        <!--when first indicator is 1-->
        <data name="dct:contributor" source="@key1001">
            <compose prefix="http://data.swissbib.ch/person/"/>
        </data>
        <data name="dct:contributor" source="@key7000">
            <compose prefix="http://data.swissbib.ch/person/"/>
        </data>
        <data name="dct:contributor" source="@key7001">
            <compose prefix="http://data.swissbib.ch/person/"/>
        </data>
        <data name="dct:contributor" source="@key710">
            <compose prefix="http://data.swissbib.ch/organisation/"/>
        </data>
        <data name="dct:contributor" source="@key711">
            <compose prefix="http://data.swissbib.ch/organisation/"/>
        </data>

        <data source="035  .a" name="bf:local">
            <regexp match="\((.*)\)(.*)" format="${1}/${2}"/>
            <unique part="value"/>
        </data>

        <combine name="item" value="http://data.swissbib.ch/item/${network}-${item_id}" flushWith="949??"
                 sameEntity="true">
            <data source="@key_item" name="item_id"/>
            <data source="949??.B" name="network"/>
        </combine>

        <data source="986  .b" name="work"/>


    </rules>
</metamorph>
